@using TaskR.Data
@model TaskR.Data.Aufgabe

@{
    ViewData["Title"] = "Aufgabe bearbeiten";
}

<h1>@ViewData["Title"]</h1>
<h5>ToDo-Liste: @ViewBag.TodoName</h5>
<hr />

<div class="btn-group">
    <a href="/FreeUser/Index" class="btn btn-primary">Zurück zur ToDo-Liste</a>
    <a href="/FreeUser/TodoDetails?TodoId=@Model.TodoId" class="btn btn-primary">Zurück zu Details</a> @* Hier gehts als Model; siehe CreateTask.cshtml *@
</div>
<br />
<br />

<table class="table" >
    <tr>
        @{
            string colorString = "";
            if (Model.Deadline <= DateTime.Now.AddDays(7))
            {
                colorString = "indianred";
            }
            if (Model.Erledigt)
            {
                colorString = "palegreen";
            }
        }
        <td>
        <div class="row">
            <div class="col-md-6" style="background-color:@colorString.ToString()" >
                <form asp-action="EditTask" method="post" id="editTaskForm" onsubmit="=fixDeadline()">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" asp-for="AufgabeId" />
                    <div class="form-group">
                        <label asp-for="Beschreibung" class="control-label"></label>
                        <input asp-for="Beschreibung" class="form-control" />
                        <span asp-validation-for="Beschreibung" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="ErstelltDatum" class="control-label"></label>
                        <input asp-for="ErstelltDatum" class="form-control" readonly/>
                        <span asp-validation-for="ErstelltDatum" class="text-danger"></span>
                    </div>
                    <div class="form-group" >
                        <label asp-for="TodoId" class="control-label">ToDo-Liste</label>
                        <div class="dropdown">@Html.DropDownList("TodoId", (IEnumerable<SelectListItem>)ViewBag.AllTodos, new { @class="form-select" })</div>
                        <br />
                    </div>
                    <div class="form-group">
                        @* <label asp-for="UserId" class="control-label"></label> *@
                        <input type="hidden" asp-for="UserId" class="form-control" />
                        <span asp-validation-for="UserId" class="text-danger"></span>
                    </div>
                    <div class="form-group form-check">
                        <label class="form-check-label">
                            <input class="form-check-input" asp-for="Erledigt" /> @Html.DisplayNameFor(model => model.Erledigt)
                        </label>
                    </div>
                    <div class="form-group">
                        <label asp-for="ErledigtDatum" class="control-label"></label>
                        <input asp-for="ErledigtDatum" type="datetime-local" class="form-control" />
                        <span asp-validation-for="ErledigtDatum" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Deadline" class="control-label"></label>
                        @* <input type="datetime-local" class="form-control" id="deadline" value="@Model.Deadline?.ToString("yyyy-MM-ddTHH:mm")" /> wichtig!!! datetime-local *@
                            <div class="input-group">
                                <div style="display: flex; gap: 5px;">
                                    <input type="date" id="datePart" class="form-control" value="@Model.Deadline?.ToString("yyyy-MM-dd")">
                                    <input type="time" id="timePart" class="form-control" value="@Model.Deadline?.ToString("HH:mm")">
                                </div>
                            </div>
                        <input type="hidden" id="Deadline" name="Deadline" />
                        <span asp-validation-for="Deadline" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Priorität" class="control-label"></label>
                        <input asp-for="Priorität" class="form-control" />
                        <span asp-validation-for="Priorität" class="text-danger"></span>
                    </div>
                    <br />
                    <div class="btn-group">
                        <input type="submit" value="Speichern" class="btn btn-success" id="submitButton"/>
                        <input type="reset" value="Zurücksetzen" class="btn btn-warning" />
                        <a href="/FreeUser/DeleteTask?TaskId=@Model.AufgabeId" class="btn btn-danger">Aufgabe löschen</a>
                    </div>
                </form>
                <br />
            </div>
        </div>
        </td>

        <td style="text-align:left; -ms-align-content:start"> @* Geht nicht !!*@
            <div>
                @foreach(var tag in Model.Tags)
                {
                    <a href="#tagEditIframe-@tag.TagId"
                       class="dropdown-toggle"
                       style="color:@tag.ColorCode?.ToString(); display:block"
                       data-bs-toggle="collapse"
                       data-bs-target="#tagEditIframe-@tag.TagId">#@tag.TagName.ToString()
                    </a>

                    <div class="collapse mt-2" id="tagEditIframe-@tag.TagId">
                        <h6>Tag bearbeiten</h6>
                        <form method="post" action="/FreeUser/EditTag">
                            <input type="hidden" name="tagId" value="@tag.TagId" />
                            <input type="hidden" name="todoId" value="@Model.Todo.TodoId" />
                            <input type="text" class="form-control" name="tagName" maxlength="10" placeholder="Tagname ohne #" value="@tag.TagName.ToString()" style="width:300px" />
                            <input type="color" class="form-control-color" name="colorCode" value="@tag.ColorCode?.ToString()"/>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-outline-success">Hinzufügen</button>
                                <button type="reset" class="btn btn-warning">Zurücksetzen</button>
                            </div>
                        </form>
                        <form method="post" action="/FreeUser/DeleteTag?@tag.TagId">
                            <input type="hidden" name="tagId" value="@tag.TagId" />
                            <input type="hidden" name="todoId" value="@tag.Aufgabe.TodoId" />
                            <button type="submit" class="btn btn-outline-danger">Löschen</button>
                        </form>
                        
                    </div>
                }
            </div>
        </td>
    </tr>
</table>

@if (Model.Deadline <= DateTime.Now.AddDays(7))
{
    <span style="color:indianred">DRINGEND </span>
}

@if (Model.Erledigt)
{
    <span style="color:palegreen">ERLEDIGT</span>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const dateInput = document.getElementById('datePart');
        const timeInput = document.getElementById('timePart');
        const hidden = document.getElementById('Deadline');

        document.getElementById("submitButton").addEventListener("click", function (e) {
            const dateVal = dateInput.value; // "YYYY-MM-DD" oder ""
            const timeVal = timeInput.value; // "HH:mm" oder ""

            if (dateVal) {
                // Wenn Datum da, aber Zeit leer -> nutze 00:00
                const finalTime = timeVal ? timeVal : "00:00";

                // Format für datetime-local im Controller: YYYY-MM-DDTHH:mm
                hidden.value = dateVal + "T" + finalTime;

                //alert("Gespeichert: " + hidden.value);
            } else {
                // Feld ist komplett leer (Nullable)
                hidden.value = "";
                //alert("Feld ist leer (NULL)");
            }
        });
    });
</script>

@if (TempData["Message"] != null)
{
    <div class="toast-container position-fixed top-50 start-50 translate-middle">
        <div id="msgToast" class="toast align-items-center text-bg-primary border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" style="color:maroon">
                    @TempData["Message"]
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function () {
            var toastEl = document.getElementById('msgToast');
            var toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
        });
    </script>
}
